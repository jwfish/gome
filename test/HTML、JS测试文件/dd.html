<html>

<head>
    <title>JavaScript TO HTML 转换</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>

    <style>
        .setme {
            background-color: #ccc;
        }
    </style>
    <button id="btn">获取</button>
    <div id="box">

        <p style="text-align:center;"><strong>Flying tortoises</strong></p>
        <p><i>An airborne reintroduction programme has helped conservationists take significant steps to protect the
                endangered Galápagos tortoise.</i></p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="1" id="q-1-5fd9622d" qn="1"
                    style="width:150px;"></span></p>
        <p><strong>A</strong>&nbsp; &nbsp; Forests of spiny cacti cover much of the uneven lava plains that separate the
            interior of the Galápagos island of Isabela from the Pacific Ocean. With its five distinct volcanoes, the
            island resembles a lunar landscape. Only the thick vegetation at the skirt of the often cloud-covered peak
            of Sierra Negra offers respite from the barren terrain below. This inhospitable environment is home to the
            giant Galápagos tortoise. Some time after the Galápagos's birth, around five million years ago, the islands
            were colonised by one or more tortoises from mainland South America. As these ancestral tortoises settled on
            the individual islands, the different populations adapted to their unique environments, giving rise to at
            least 14 different subspecies. Island life agreed with them. In the absence of significant predators, they
            grew to become the largest and longest-living tortoises on the planet, weighing more than 400 kilograms,
            occasionally exceeding 1.8 metres in length and living for more than a century.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="2" id="q-2-5fd96230" qn="2"
                    style="width:150px;"></span></p>
        <p><strong>B&nbsp;</strong> &nbsp; Before human arrival, the archipelago's tortoises numbered in the hundreds of
            thousands. From the 17th century onwards, pirates took a few on board for food, but the arrival of whaling
            ships in the 1790s saw this exploitation grow exponentially. Relatively immobile and capable of surviving
            for months without food or water, the tortoises were taken on board these ships to act as food supplies
            during long ocean passages. Sometimes, their bodies were processed into high-grade oil. In total, an
            estimated 200,000 animals were taken from the archipelago before the 20th century. This historical
            exploitation was then exacerbated when settlers came to the islands. They hunted the tortoises and destroyed
            their habitat to clear land for agriculture. They also introduced alien species - ranging from cattle, pigs,
            goats, rats and dogs to plants and ants - that either prey on the eggs and young tortoises or damage or
            destroy their habitat.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="3" id="q-3-5fd96233" qn="3"
                    style="width:150px;"></span></p>
        <p><strong>C</strong>&nbsp; &nbsp; Today, only 11 of the original subspecies survive and of these, several are
            highly endangered. In 1989, work began on a tortoise-breeding centre just outside the town of Puerto
            Villamil on Isabela, dedicated to protecting the island's tortoise populations. The centre's
            captive-breeding programme proved to be extremely successful, and it eventually had to deal with an
            overpopulation problem.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="4" id="q-4-5fd96236" qn="4"
                    style="width:150px;"></span></p>
        <p><strong>D&nbsp;</strong> &nbsp; The problem was also a pressing one. Captive-bred tortoises can't be
            reintroduced into the wild until they're at least five years old and weigh at least 4.5 kilograms, at which
            point their size and weight - and their hardened shells - are sufficient to protect them from predators. But
            if people wait too long after that point, the tortoises eventually become too large to transport.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="5" id="q-5-5fd96239" qn="5"
                    style="width:150px;"></span></p>
        <p><strong>E</strong>&nbsp; &nbsp; For years, repatriation efforts were carried out in small numbers, with the
            tortoises carried on the backs of men over weeks of long, treacherous hikes along narrow trails. But in
            November 2010, the environmentalist and Galápagos National Park liaison officer Godfrey Merlin, a visiting
            private motor yacht captain and a helicopter pilot gathered around a table in a small cafe in Puerto Ayora
            on the island of Santa Cruz to work out more ambitious reintroduction. The aim was to use a helicopter to
            move 300 of the breeding centre's tortoises to various locations close to Sierra Negra.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="6" id="q-6-5fd9623e" qn="6"
                    style="width:150px;"></span></p>
        <p><strong>F&nbsp;</strong> &nbsp; This unprecedented effort was made possible by the owners of the 67-metre
            yacht White Cloud, who provided the Galápagos National Park with free use of their helicopter and its
            experienced pilot, as well as the logistical support of the yacht, its captain and crew. Originally an air
            ambulance, the yacht's helicopter has a rear double door and a large internal space that's well suited for
            cargo, so a custom crate was designed to hold up to 33 tortoises with a total weight of about 150 kilograms.
            This weight, together with that of the fuel, pilot and four crew, approached the helicopter's maximum
            payload, and there were times when it was clearly right on the edge of the helicopter's capabilities. During
            a period of three days, a group of volunteers from the breeding centre worked around the clock to prepare
            the young tortoises for transport. Meanwhile, park wardens, dropped off ahead of time in remote locations,
            cleared landing sites within the thick brush, cacti and lava rocks.</p>
        <p><span class="qinput" contenteditable="false"><input type="text" placeholder="7" id="q-7-5fd96241" qn="7"
                    style="width:150px;"></span></p>
        <p><strong>G&nbsp;</strong> &nbsp; Upon their release, the juvenile tortoises quickly spread out over their
            ancestral territory, investigating their new surroundings and feeding on the vegetation. Eventually, one
            tiny tortoise came across a fully grown giant who had been lumbering around the island for around a hundred
            years. The two stood side by side, a powerful symbol of the regeneration of an ancient species.</p>
    </div>
</body>
<script src="./jq.min.js"></script>
<script src="./rangy.js"></script>
<script src="./web-highlighter.min.js"></script>

<script>
    // (new Highlighter()).run();


    $('#btn').click(() => {
        var range1 = document.getSelection().getRangeAt(0);



        var fragment = range1.extractContents()
        var span1 = document.createElement("span")
        span1.className = "setme";

        // mark()
        range1.insertNode()

    })

    function domIndexFunc(dom, parentDom) {
        for (var i = 0, len = parentDom.childNodes.length; i < len; i++) {
            if (dom == parentDom.childNodes[i]) {
                return i;
            }
        }
    }


    function mark() {

        var _sel = rangy.getSelection();
        console.log("_sel", _sel)
        var _curr_range = _sel.getRangeAt(0);
        console.log("_curr_range", _curr_range)

        var _an = _sel.anchorNode;
        console.log("_an", _an)
        var _anp = _sel.anchorNode.parentNode;
        console.log("_anp", _anp)
        var _fn = _sel.focusNode;
        var _fnp = _sel.focusNode.parentNode;
        var _startIndex = _sel.anchorOffset;
        var _endIndex = _sel.focusOffset;


        var _prevLenFunc = function (_domIndex, parentDom, type) {
            var _totalLen = 0;
            for (var i = 0, len = _domIndex; i < len; i++) {
                var _curNode = parentDom.childNodes[i];
                if (_curNode.textContent.length) {
                    if (type == "insertMark") {
                        // 不计算标签的内容的长度
                        if (_curNode.nodeType == 1 && !$(_curNode).hasClass("setme")) {
                            _totalLen += 0;
                        } else if ((_curNode.nodeType == 1 && $(_curNode).hasClass("setme")) || _curNode.nodeType ==
                            3) {
                            _totalLen += _curNode.textContent.length;
                        }
                    } else if (type == "markContent") {
                        if ((_curNode.nodeType == 1 && $(_curNode).hasClass("setme")) || _curNode.nodeType == 3) {
                            // 计算标签的内容的长度
                            _totalLen += _curNode.textContent.length;
                        } else if (_curNode.nodeType == 1 && !$(_curNode).hasClass("setme")) {
                            _totalLen += 0;
                        }
                    }
                } else {

                    _totalLen += 4; // <br>
                }
            }
            return _totalLen;
        };




        var _selectStartDomLoca = domIndexFunc(_an, _anp);
        console.log('开始', _selectStartDomLoca)
        var _selectEndDomLoca = domIndexFunc(_fn, _fnp);
        console.log('开始', _selectEndDomLoca)


        var _spanElm = document.createElement("span");
        _spanElm.className = "setme bgc2b";

        _curr_range.surroundContents(_spanElm);
    }
</script>

</html>